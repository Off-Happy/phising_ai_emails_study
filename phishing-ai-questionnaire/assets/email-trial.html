<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mock Email Trial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- reVISit bridge: adjust path if your repo is organized differently -->
  <script src="../../revisitUtilities/revisit-communicate.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background:#fafafa; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; }
    .hdr { padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#fcfcfd; }
    .hdr .row { margin:4px 0; }
    .hdr button { font:inherit; padding:4px 8px; cursor:pointer; }
    .details { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f8fafc; padding:8px; border:1px dashed #cbd5e1; border-radius:6px; margin-top:8px; }
    .body { padding:16px; line-height:1.5; }
    .body a { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="card" id="emailCard">
    <div class="hdr" id="hdr">
      <div class="row"><b>From:</b> <span id="fromName">IT Support</span> &lt;<span id="fromAddr">security@university-helpdesk.com</span>&gt;</div>
      <div class="row"><b>Subject:</b> <span id="subject">Password expiry: verify within 24 hours</span></div>
      <div class="row"><button id="toggleDetails" type="button">Show details</button></div>
      <div id="details" class="details" hidden>
        <div><b>Return-Path:</b> &lt;security@university-helpdesk.com&gt;</div>
        <div><b>Reply-To:</b> support@university-helpdesk.com</div>
        <div><b>DKIM:</b> none</div>
        <div><b>SPF:</b> softfail</div>
      </div>
    </div>
    <div class="body" id="body">
      <p>Dear user,</p>
      <p>Your password will expire today. To avoid losing access, please <a href="#/update">update your password</a> immediately.</p>
      <p>Regards,<br>IT Service Desk</p>
    </div>
  </div>

  <script>
    // --- state ---
    const events = [];
    const t0 = performance.now();
    function now() { return Math.round(performance.now() - t0); }
    function log(e) { events.push({ t: now(), ...e }); }

    // --- populate from parameters if provided (supports external JSON or inline object) ---
    Revisit.onDataReceive(async (data) => {
      const em = typeof data?.email === "string"
        ? await fetch(data.email).then(r => r.json()).catch(() => null)
        : (data?.email || null);
      if (em) {
        document.getElementById("fromName").textContent = em.fromName || "";
        document.getElementById("fromAddr").textContent = em.from || "";
        document.getElementById("subject").textContent = em.subject || "";
        // Ensure bodyHTML is sanitized at build time if sourced externally.
        if (em.bodyHTML) document.getElementById("body").innerHTML = em.bodyHTML;
      }
      log({ type: "trialStart" });
      Revisit.postAnswers({ events }); // optional incremental flush
    });

    // --- link interception + normalization ---
    function normalize(url) {
      try { return new URL(url, "https://x.invalid").hostname.toLowerCase(); }
      catch { return ""; }
    }
    document.getElementById("body").addEventListener("click", (e) => {
      const a = e.target.closest("a"); if (!a) return;
      e.preventDefault(); // never navigate
      const href = a.getAttribute("href") || "";
      log({ type: "linkAttempt", shown: (a.textContent||"").trim(), href, host: normalize(href) });
      Revisit.postAnswers({ events });
    }, true);

    // --- header visibility and hover as proxies for "checked header" ---
    const hdr = document.getElementById("hdr");
    let hdrHoverStart = null, hdrHoverMs = 0;
    hdr.addEventListener("mouseenter", () => { hdrHoverStart = performance.now(); log({ type: "hdrHoverEnter" }); });
    hdr.addEventListener("mouseleave", () => {
      if (hdrHoverStart) hdrHoverMs += performance.now() - hdrHoverStart;
      hdrHoverStart = null; log({ type: "hdrHoverLeave", hoverMs: Math.round(hdrHoverMs) });
    });
    let hdrVisibleStart = null, hdrVisibleMs = 0;
    const io = new IntersectionObserver(([entry]) => {
      if (entry.intersectionRatio >= 0.6 && hdrVisibleStart == null) {
        hdrVisibleStart = performance.now(); log({ type: "hdrVisibleEnter" });
      } else if (entry.intersectionRatio < 0.6 && hdrVisibleStart != null) {
        hdrVisibleMs += performance.now() - hdrVisibleStart;
        hdrVisibleStart = null; log({ type: "hdrVisibleLeave", visibleMs: Math.round(hdrVisibleMs) });
      }
    }, { threshold: [0, 0.6, 1] });
    io.observe(hdr);

    // --- details toggle as explicit header inspection ---
    const toggle = document.getElementById("toggleDetails");
    const details = document.getElementById("details");
    toggle.addEventListener("click", () => {
      details.hidden = !details.hidden;
      toggle.textContent = details.hidden ? "Show details" : "Hide details";
      log({ type: "hdrDetailsToggle", opened: !details.hidden });
      Revisit.postAnswers({ events });
    });

    // --- flush on exit (participant clicks Next) ---
    window.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        if (hdrHoverStart) { hdrHoverMs += performance.now() - hdrHoverStart; hdrHoverStart = null; }
        if (hdrVisibleStart) { hdrVisibleMs += performance.now() - hdrVisibleStart; hdrVisibleStart = null; }
        Revisit.postAnswers({
          events,
          metrics: {
            hdrHoverMs: Math.round(hdrHoverMs),
            hdrVisibleMs: Math.round(hdrVisibleMs)
          }
        });
      }
    });
  </script>
</body>
</html>
